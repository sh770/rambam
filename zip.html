<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>× ×™×”×•×œ ×”×’×¨×œ×” - ×–×¨×™××” ×××•×‘×˜×—×ª</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <style>
        :root { --primary: #1a237e; --bg: #f5f7f9; --accent: #2e7d32; --error: #c62828; }
        * { box-sizing: border-box; font-family: 'Segoe UI', system-ui, sans-serif; }
        body { background: var(--bg); padding: 5px; direction: rtl; margin: 0; }
        .card { background: white; padding: 12px; border-radius: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); margin-bottom: 15px; }
        h1, h2 { text-align: center; color: var(--primary); margin-bottom: 12px; font-size: 1.2rem; }
        
        .btn { width: 100%; padding: 12px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; color: white; margin-top: 8px; transition: 0.3s; }
        .btn-blue { background: #3949ab; }
        .btn-green { background: var(--accent); }
        .btn-red { background: var(--error); font-size: 0.8em; }
        .btn:disabled { background: #ccc !important; cursor: not-allowed; opacity: 0.6; }

        .instruction-box { background: #fff3e0; border-right: 5px solid #ff9800; padding: 10px; margin: 10px 0; font-size: 0.9em; display: none; }
        .input-row { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin: 10px 0; }
        label { font-size: 0.85em; font-weight: bold; display: block; margin-bottom: 3px; }
        input[type="date"] { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 5px; font-size: 0.9em; }

        .table-wrap { width: 100%; border: 1px solid #eee; border-radius: 6px; overflow: hidden; margin-top: 5px; }
        table { width: 100%; border-collapse: collapse; table-layout: fixed; background: white; }
        th, td { padding: 8px 4px; text-align: center; border-bottom: 1px solid #eee; font-size: 0.85em; word-wrap: break-word; }
        th { background: #f0f2f5; font-weight: bold; }
        .col-name { width: 40%; text-align: right; padding-right: 8px; }
        
        .badge { padding: 2px 4px; border-radius: 4px; display: inline-block; font-weight: bold; }
        .bg-tix { background: #ffe0b2; color: #e65100; }
        .user-row { background: #e8eaf6; font-weight: bold; text-align: right; }
        .sum-row { background: #fff9c4; font-weight: bold; }
        
        #status { text-align: center; font-size: 0.85em; margin: 8px 0; color: var(--accent); font-weight: bold; }
    </style>
</head>
<body>

<div class="card" id="controlPanel">
    <h1>ğŸŸï¸ × ×™×”×•×œ ×”×’×¨×œ×”</h1>
    
    <input type="file" id="zipFile" onchange="onFileSelected()" style="display: none;">
    <label id="zipLabel" for="zipFile" class="btn btn-blue" style="display: block; text-align: center;">ğŸ“‚ 1. ×˜×¢×Ÿ ×§×•×‘×¥ ZIP</label>
    
    <div id="status"></div>

    <div id="instructions" class="instruction-box">
        <strong>×”×§×•×‘×¥ × ×§×œ×˜!</strong><br>
        ×›×¢×ª × ×™×ª×Ÿ ×œ×‘×—×•×¨ ×˜×•×•×— ×ª××¨×™×›×™× (××•×¤×¦×™×•× ×œ×™) ×•×œ×œ×—×•×¥ ×¢×œ "×‘×¦×¢ × ×™×ª×•×— ×•×¢×“×›×•×Ÿ". ×©×™× ×œ×‘: ×œ××—×¨ ×”×œ×—×™×¦×” ×”× ×ª×•× ×™× ×™×™×©××¨×• ×‘×–×™×›×¨×•×Ÿ ×•×œ× × ×™×ª×Ÿ ×™×”×™×” ×œ×”×¨×™×¥ ××ª ××•×ª×• ×§×•×‘×¥ ×©×•×‘.
    </div>

    <div class="input-row">
        <div><label>××™×•×:</label><input type="date" id="fromDate" disabled></div>
        <div><label>×¢×“ ×™×•×:</label><input type="date" id="toDate" disabled></div>
    </div>
    
    <button id="analyzeBtn" class="btn btn-green" onclick="runAnalysis()" disabled>ğŸš€ 2. ×‘×¦×¢ × ×™×ª×•×— ×•×¢×“×›×•×Ÿ ×–×™×›×¨×•×Ÿ</button>
</div>

<div id="outputArea">
    <div class="card" id="summaryCard" style="display:none;">
        <h2>ğŸ“‹ ×¡×™×›×•× ×”×’×¨×œ×” ××¦×˜×‘×¨</h2>
        <div class="table-wrap">
            <table id="summaryTable">
                <thead>
                    <tr>
                        <th class="col-name">×©×</th>
                        <th style="width:18%">×¡×‘×‘ ×–×”</th>
                        <th style="width:24%">×›×¨×˜×™×¡×™×</th>
                        <th style="width:18%">×©××¨</th>
                    </tr>
                </thead>
                <tbody id="summaryBody"></tbody>
            </table>
        </div>
        <button class="btn btn-blue" id="copyBtn" onclick="copyTable('summaryTable')">ğŸ“‹ ×”×¢×ª×§ ×˜×‘×œ×”</button>
    </div>

    <div class="card" id="detailCard" style="display:none;">
        <h2>ğŸ“ ×¤×™×¨×•×˜ ×”×•×“×¢×•×ª ××”×¡×‘×‘ ×”××—×¨×•×Ÿ</h2>
        <div class="table-wrap">
            <table id="detailTable">
                <thead>
                    <tr>
                        <th style="width: 25%;">×ª××¨×™×š</th>
                        <th style="width: 60%; text-align: right;">×”×•×“×¢×”</th>
                        <th style="width: 15%;">× ×§'</th>
                    </tr>
                </thead>
                <tbody id="detailBody"></tbody>
            </table>
        </div>
    </div>

    <div style="padding: 10px;">
        <button id="clearBtn" class="btn btn-red" onclick="clearMemory()">âš ï¸ ××¤×¡ ××ª ×›×œ ×”× ×ª×•× ×™× ×‘×–×™×›×¨×•×Ÿ</button>
    </div>
</div>

<script>
let currentFileMessages = [];
const TICKET_THRESHOLD = 7;

window.addEventListener('DOMContentLoaded', () => {
    loadStoredData();
});

function loadStoredData() {
    const data = localStorage.getItem("participants");
    if (data) {
        const participants = JSON.parse(data);
        if (participants.length > 0) {
            document.getElementById('summaryCard').style.display = 'block';
            document.getElementById('clearBtn').style.display = 'block';
            renderSummaryOnly(participants);
        }
    }
}

async function onFileSelected() {
    const file = document.getElementById('zipFile').files[0];
    if (!file) return;

    const status = document.getElementById('status');
    status.textContent = '××—×œ×¥ × ×ª×•× ×™×...';
    
    try {
        const zip = await JSZip.loadAsync(file);
        let text = '';
        const files = Object.keys(zip.files).filter(name => name.endsWith('.txt'));
        for (let name of files) { text += await zip.files[name].async('string') + '\n'; }
        
        currentFileMessages = parse(text);
        
        // ×¢×“×›×•×Ÿ ×××©×§ ×œ××—×¨ ×˜×¢×™× ×” ××•×¦×œ×—×ª
        status.textContent = `× ××¦××• ${currentFileMessages.length} ×”×•×“×¢×•×ª × ×™×§×•×“.`;
        document.getElementById('instructions').style.display = 'block';
        document.getElementById('fromDate').disabled = false;
        document.getElementById('toDate').disabled = false;
        document.getElementById('analyzeBtn').disabled = false;
        document.getElementById('zipLabel').style.opacity = '0.5';
    } catch (e) {
        status.textContent = '×©×’×™××” ×‘×—×™×œ×•×¥ ×”×§×•×‘×¥.';
        status.style.color = 'red';
    }
}

function parse(text) {
    const lines = text.split('\n');
    const parsed = [];
    const r1 = /^\[(\d{1,2})\.(\d{1,2}),\s*\d{1,2}:\d{2}\]\s*(.+?):\s*(.+)$/;
    const r2 = /^(\d{1,2})\.(\d{1,2})\.\d{4},\s*\d{1,2}:\d{2}\s*-\s*(.+?):\s*(.+)$/;
    for (let line of lines) {
        let m = line.match(r1) || line.match(r2);
        if (m) {
            let content = m[m.length-1].trim();
            let pts = content.includes('âœ…') ? 3 : content.includes('âœ”ï¸') ? 2 : content.includes('â™»ï¸') ? 1 : 0;
            if (pts > 0) {
                parsed.push({
                    date: `${m[1]}.${m[2]}`,
                    dateObj: new Date(2026, m[2]-1, m[1]),
                    sender: m[m.length-2].trim().replace(/\u200F|\u200E/g, ""),
                    content: content, pts: pts
                });
            }
        }
    }
    return parsed;
}

function runAnalysis() {
    // ×× ×™×¢×ª ×œ×—×™×¦×” ×›×¤×•×œ×” - × ×¢×™×œ×ª ×”×××©×§ ××™×“
    const btn = document.getElementById('analyzeBtn');
    btn.disabled = true;
    document.getElementById('zipFile').disabled = true;
    document.getElementById('fromDate').disabled = true;
    document.getElementById('toDate').disabled = true;
    
    document.getElementById('status').textContent = '×”× ×ª×•× ×™× ×¢×•×“×›× ×• ×‘×–×™×›×¨×•×Ÿ ×•× × ×¢×œ×•.';
    document.getElementById('instructions').innerHTML = 'âœ… <strong>×”×¢×“×›×•×Ÿ ×”×•×©×œ×!</strong> ×”× ×ª×•× ×™× × ×©××¨×•. ×›×“×™ ×œ×”×–×™×Ÿ ×§×•×‘×¥ ×—×“×©, ×™×© ×œ×¨×¢× ×Ÿ ××ª ×”×“×£.';

    analyzeAndSave();
}

function analyzeAndSave() {
    const fromVal = document.getElementById('fromDate').value;
    const toVal = document.getElementById('toDate').value;
    const from = fromVal ? new Date(fromVal) : null;
    const to = toVal ? new Date(toVal) : null;

    const currentResults = {};
    const filtered = currentFileMessages.filter(m => {
        if (from && m.dateObj < from) return false;
        if (to && m.dateObj > to) return false;
        return true;
    });

    filtered.forEach(m => {
        if (!currentResults[m.sender]) currentResults[m.sender] = { pts: 0, msgs: [] };
        currentResults[m.sender].pts += m.pts;
        currentResults[m.sender].msgs.push(m);
    });

    let stored = [];
    try {
        const data = localStorage.getItem("participants");
        stored = data ? JSON.parse(data) : [];
    } catch(e) { console.error(e); }

    const previousMap = {};
    stored.forEach(p => previousMap[p.name] = p);

    const allNames = new Set([...Object.keys(currentResults), ...Object.keys(previousMap)]);
    
    const updatedParticipants = Array.from(allNames).map(name => {
        const cur = currentResults[name] || { pts: 0 };
        const prev = previousMap[name] || { tickets: 0, remainder: 0 };
        const totalToCalculate = cur.pts + prev.remainder;
        const newTickets = Math.floor(totalToCalculate / TICKET_THRESHOLD);
        
        return {
            name: name,
            tickets: prev.tickets + newTickets,
            remainder: totalToCalculate % TICKET_THRESHOLD,
            currentCyclePts: cur.pts
        };
    });

    localStorage.setItem("participants", JSON.stringify(updatedParticipants));
    
    renderAll(updatedParticipants, currentResults);
    document.getElementById('summaryCard').style.display = 'block';
    document.getElementById('detailCard').style.display = 'block';
}

function renderSummaryOnly(participants) {
    let sHtml = '';
    participants.sort((a,b) => b.tickets - a.tickets || b.remainder - a.remainder).forEach(p => {
        sHtml += `<tr><td class="col-name"><strong>${p.name}</strong></td><td>-</td><td><span class="badge bg-tix">${p.tickets}</span></td><td>${p.remainder}</td></tr>`;
    });
    document.getElementById('summaryBody').innerHTML = sHtml;
}

function renderAll(participants, currentResults) {
    let sHtml = '';
    participants.sort((a,b) => b.tickets - a.tickets || b.remainder - a.remainder).forEach(p => {
        sHtml += `<tr><td class="col-name"><strong>${p.name}</strong></td><td>${p.currentCyclePts || 0}</td><td><span class="badge bg-tix">${p.tickets}</span></td><td>${p.remainder}</td></tr>`;
    });
    document.getElementById('summaryBody').innerHTML = sHtml;

    let dHtml = '';
    Object.entries(currentResults).sort((a,b) => b[1].pts - a[1].pts).forEach(([name, data]) => {
        dHtml += `<tr class="user-row"><td colspan="3">ğŸ‘¤ ${name}</td></tr>`;
        data.msgs.forEach(m => {
            dHtml += `<tr><td>${m.date}</td><td style="text-align:right">${m.content}</td><td>${m.pts}</td></tr>`;
        });
        dHtml += `<tr class="sum-row"><td colspan="2" style="text-align:left">×¡×”"×› ×¡×‘×‘:</td><td>${data.pts}</td></tr>`;
    });
    document.getElementById('detailBody').innerHTML = dHtml;
}

function clearMemory() {
    if (confirm("âš ï¸ ×–×” ×™××—×§ ××ª ×›×œ ×”×™×¡×˜×•×¨×™×™×ª ×”×›×¨×˜×™×¡×™×. ×”×× ×œ×”××©×™×š?")) {
        localStorage.removeItem("participants");
        location.reload();
    }
}

function copyTable(id) {
    const el = document.getElementById(id);
    let range = document.createRange();
    range.selectNode(el);
    window.getSelection().removeAllRanges();
    window.getSelection().addRange(range);
    document.execCommand('copy');
    alert('×”×˜×‘×œ×” ×”×•×¢×ª×§×”!');
}
</script>
</body>
</html>
