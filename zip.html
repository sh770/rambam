<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>××¢×¨×›×ª ×”×’×¨×œ×” - ×¢× ×©××™×¨×” ×‘×–×™×›×¨×•×Ÿ</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <style>
        :root { --primary: #1a237e; --bg: #f5f7f9; }
        * { box-sizing: border-box; font-family: 'Segoe UI', system-ui, sans-serif; }
        body { background: var(--bg); padding: 5px; direction: rtl; margin: 0; }
        .card { background: white; padding: 12px; border-radius: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); margin-bottom: 15px; }
        h1, h2 { text-align: center; color: var(--primary); margin-bottom: 12px; font-size: 1.3rem; }
        .btn { width: 100%; padding: 12px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; color: white; margin-top: 8px; }
        .btn-blue { background: #3949ab; }
        .btn-green { background: #2e7d32; }
        .btn-red { background: #c62828; margin-top: 20px; font-size: 0.8em; opacity: 0.8; }
        .btn:disabled { background: #ccc; }
        .input-row { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin: 10px 0; }
        label { font-size: 0.85em; font-weight: bold; }
        input[type="date"] { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 5px; font-size: 0.9em; }
        .table-wrap { width: 100%; border: 1px solid #eee; border-radius: 6px; overflow: hidden; margin-top: 5px; }
        table { width: 100%; border-collapse: collapse; table-layout: fixed; background: white; }
        th, td { padding: 8px 4px; text-align: center; border-bottom: 1px solid #eee; font-size: 0.85em; word-wrap: break-word; }
        th { background: #f0f2f5; font-weight: bold; }
        .col-name { width: 40%; text-align: right; padding-right: 8px; }
        .user-row { background: #e8eaf6; font-weight: bold; color: var(--primary); text-align: right; }
        .sum-row { background: #fff9c4; font-weight: bold; font-size: 0.9em; }
        .badge { padding: 2px 4px; border-radius: 4px; display: inline-block; }
        .bg-pts { background: #c8e6c9; color: #1b5e20; }
        .bg-tix { background: #ffe0b2; color: #e65100; }
        #status { text-align: center; font-size: 0.85em; margin: 8px 0; color: #e65100; min-height: 1.2em; }
    </style>
</head>
<body>

<div class="card">
    <h1>ğŸŸï¸ × ×™×”×•×œ ×”×’×¨×œ×” ×¦×‘×•×¨</h1>
    <input type="file" id="zipFile" onchange="onFileSelected()" style="display: none;">
    <label for="zipFile" class="btn btn-blue" style="display: block; text-align: center;">ğŸ“‚ ×˜×¢×Ÿ ×§×•×‘×¥ ZIP ×—×“×©</label>
    <button id="extractBtn" class="btn btn-blue" onclick="extractData()" disabled>ğŸ“¥ ×©×œ×‘ 1: ×—×œ×¥</button>
    
    <div id="status">×××ª×™×Ÿ ×œ×§×•×‘×¥...</div>

    <div class="input-row">
        <div><label>××™×•×:</label><input type="date" id="fromDate"></div>
        <div><label>×¢×“ ×™×•×:</label><input type="date" id="toDate"></div>
    </div>
    <button id="analyzeBtn" class="btn btn-green" onclick="run()" disabled>ğŸš€ ×©×œ×‘ 2: ×¢×“×›×Ÿ ×–×™×›×¨×•×Ÿ ×•×”×¤×§ ×“×•×—</button>
</div>

<div id="outputArea" style="display:none;">
    <div class="card">
        <h2>ğŸ“Š ×¡×™×›×•× ××¦×˜×‘×¨ (××›×œ ×”×¡×‘×‘×™×)</h2>
        <div class="table-wrap">
            <table id="summaryTable">
                <thead>
                    <tr>
                        <th class="col-name">×©×</th>
                        <th style="width:18%">× ×§'</th>
                        <th style="width:24%">×›×¨×˜×™×¡×™×</th>
                        <th style="width:18%">×©××¨</th>
                    </tr>
                </thead>
                <tbody id="summaryBody"></tbody>
            </table>
        </div>
        <button class="btn btn-blue" onclick="copyTable('summaryTable')">ğŸ“‹ ×”×¢×ª×§ ×˜×‘×œ×”</button>
    </div>

    <div class="card">
        <h2>ğŸ“ ×¤×™×¨×•×˜ ×¡×‘×‘ × ×•×›×—×™</h2>
        <div class="table-wrap">
            <table id="detailTable">
                <thead>
                    <tr>
                        <th style="width: 20%;">×ª××¨×™×š</th>
                        <th style="width: 65%; text-align: right;">×”×•×“×¢×”</th>
                        <th style="width: 15%;">× ×§'</th>
                    </tr>
                </thead>
                <tbody id="detailBody"></tbody>
            </table>
        </div>
    </div>

    <button class="btn btn-red" onclick="clearMemory()">âš ï¸ ××¤×¡ ××ª ×›×œ ×”× ×ª×•× ×™× ×‘×–×™×›×¨×•×Ÿ</button>
</div>

<script>
let currentFileMessages = [];
const TICKET_THRESHOLD = 7;

function onFileSelected() {
    document.getElementById('extractBtn').disabled = false;
    document.getElementById('status').textContent = '×§×•×‘×¥ ××•×›×Ÿ ×œ×—×™×œ×•×¥.';
}

async function extractData() {
    const file = document.getElementById('zipFile').files[0];
    document.getElementById('status').textContent = '××—×œ×¥...';
    try {
        const zip = await JSZip.loadAsync(file);
        let text = '';
        for (let name in zip.files) {
            if (name.endsWith('.txt')) text += await zip.files[name].async('string') + '\n';
        }
        currentFileMessages = parse(text);
        document.getElementById('analyzeBtn').disabled = false;
        document.getElementById('status').textContent = `×–×•×”×• ${currentFileMessages.length} ×”×•×“×¢×•×ª × ×™×§×•×“.`;
    } catch (e) { document.getElementById('status').textContent = '×©×’×™××” ×‘×—×™×œ×•×¥.'; }
}

function parse(text) {
    const lines = text.split('\n');
    const parsed = [];
    const r1 = /^\[(\d{1,2})\.(\d{1,2}),\s*\d{1,2}:\d{2}\]\s*(.+?):\s*(.+)$/;
    const r2 = /^(\d{1,2})\.(\d{1,2})\.\d{4},\s*\d{1,2}:\d{2}\s*-\s*(.+?):\s*(.+)$/;
    for (let line of lines) {
        let m = line.match(r1) || line.match(r2);
        if (m) {
            let content = m[m.length-1].trim();
            let pts = content.includes('âœ…') ? 3 : content.includes('âœ”ï¸') ? 2 : content.includes('â™»ï¸') ? 1 : 0;
            if (pts > 0) {
                parsed.push({
                    date: `${m[1]}.${m[2]}`,
                    dateObj: new Date(2026, m[2]-1, m[1]),
                    sender: m[m.length-2].trim().replace(/\u200F|\u200E/g, ""),
                    content: content, pts: pts
                });
            }
        }
    }
    return parsed;
}

function run() {
    const btn = document.getElementById('analyzeBtn');
    btn.textContent = '××¢×‘×“ ×•×©×•××¨...';
    setTimeout(() => {
        analyzeAndSave();
        document.getElementById('outputArea').style.display = 'block';
        btn.textContent = 'ğŸš€ ×¢×“×›×•×Ÿ ×‘×•×¦×¢!';
        btn.disabled = false;
    }, 50);
}

function analyzeAndSave() {
    const fromVal = document.getElementById('fromDate').value;
    const toVal = document.getElementById('toDate').value;
    const from = fromVal ? new Date(fromVal) : null;
    const to = toVal ? new Date(toVal) : null;

    // 1. ×¡×™× ×•×Ÿ ×”×•×“×¢×•×ª ××”×§×•×‘×¥ ×”× ×•×›×—×™
    const currentResults = {};
    const filtered = currentFileMessages.filter(m => {
        if (from && m.dateObj < from) return false;
        if (to && m.dateObj > to) return false;
        return true;
    });

    filtered.forEach(m => {
        if (!currentResults[m.sender]) currentResults[m.sender] = { pts: 0, msgs: [] };
        currentResults[m.sender].pts += m.pts;
        currentResults[m.sender].msgs.push(m);
    });

    // 2. ×˜×¢×™× ×ª × ×ª×•× ×™× ×§×•×“××™× ××”-LocalStorage
    let stored = [];
    try {
        const data = localStorage.getItem("participants");
        stored = data ? JSON.parse(data) : [];
    } catch(e) { console.error(e); }

    const previousMap = {};
    stored.forEach(p => previousMap[p.name] = p);

    // 3. ××™×—×•×“ ×•×—×™×©×•×‘ ××—×“×©
    const allNames = new Set([...Object.keys(currentResults), ...Object.keys(previousMap)]);
    
    const updatedParticipants = Array.from(allNames).map(name => {
        const cur = currentResults[name] || { pts: 0 };
        const prev = previousMap[name] || { tickets: 0, remainder: 0 };

        const totalToCalculate = cur.pts + prev.remainder;
        const newTickets = Math.floor(totalToCalculate / TICKET_THRESHOLD);
        const remainder = totalToCalculate % TICKET_THRESHOLD;

        return {
            name: name,
            tickets: prev.tickets + newTickets,
            remainder: remainder,
            currentCyclePts: cur.pts // ×œ×¦×¨×›×™ ×ª×¦×•×’×” ×‘×œ×‘×“
        };
    });

    // 4. ×©××™×¨×” ×—×–×¨×” ×œ-LocalStorage
    localStorage.setItem("participants", JSON.stringify(updatedParticipants));

    // 5. ×¨×™× ×“×•×¨ ×˜×‘×œ××•×ª
    renderTables(updatedParticipants, currentResults);
}

function renderTables(participants, currentResults) {
    // ×˜×‘×œ×ª ×¡×™×›×•×
    let sHtml = '';
    participants.sort((a,b) => b.tickets - a.tickets || b.remainder - a.remainder).forEach(p => {
        sHtml += `<tr>
            <td class="col-name"><strong>${p.name}</strong></td>
            <td>${p.currentCyclePts || 0}</td>
            <td><span class="badge bg-tix">${p.tickets}</span></td>
            <td>${p.remainder}</td>
        </tr>`;
    });
    document.getElementById('summaryBody').innerHTML = sHtml;

    // ×˜×‘×œ×ª ×¤×™×¨×•×˜ (×¡×‘×‘ × ×•×›×—×™ ×‘×œ×‘×“)
    let dHtml = '';
    Object.entries(currentResults).sort((a,b) => b[1].pts - a[1].pts).forEach(([name, data]) => {
        dHtml += `<tr class="user-row"><td colspan="3">ğŸ‘¤ ${name}</td></tr>`;
        data.msgs.forEach(m => {
            dHtml += `<tr><td>${m.date}</td><td style="text-align:right">${m.content}</td><td>${m.pts}</td></tr>`;
        });
        dHtml += `<tr class="sum-row"><td colspan="2" style="text-align:left">×¡×”"×› ×œ×¡×‘×‘:</td><td>${data.pts}</td></tr>`;
    });
    document.getElementById('detailBody').innerHTML = dHtml;
}

function clearMemory() {
    if (confirm("×”×× ××ª×” ×‘×˜×•×— ×©×‘×¨×¦×•× ×š ×œ××—×•×§ ××ª ×›×œ ×”×¡×˜×•×¨×™×™×ª ×”×›×¨×˜×™×¡×™× ×•×”× ×§×•×“×•×ª?")) {
        localStorage.removeItem("participants");
        location.reload();
    }
}

function copyTable(id) {
    const el = document.getElementById(id);
    let range = document.createRange();
    range.selectNode(el);
    window.getSelection().removeAllRanges();
    window.getSelection().addRange(range);
    document.execCommand('copy');
    alert('×”×˜×‘×œ×” ×”×•×¢×ª×§×” ×œ×œ×•×—!');
}
</script>
</body>
</html>
