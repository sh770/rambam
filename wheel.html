<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>专转 专住</title>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.3/dist/confetti.browser.min.js"></script>
    <style>
        :root { --primary: #1a237e; --gold: #c5a059; --bg: #f4f7f6; --accent: #3949ab; --error: #c62828; }
        * { box-sizing: border-box; font-family: 'Segoe UI', system-ui, sans-serif; }
        body { background: var(--bg); margin: 0; padding: 20px; display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 100vh; color: #333; }
        
        .raffle-container { text-align: center; width: 100%; max-width: 500px; }
        
        .raffle-box {
            background: #fff; 
            min-height: 350px; 
            border: 2px solid #ddd; 
            border-radius: 20px;
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            justify-content: space-between;
            position: relative; 
            overflow: hidden; 
            box-shadow: 0 15px 35px rgba(0,0,0,0.1); 
            padding: 40px 20px;
            margin-bottom: 25px;
        }

        #current-name { 
            font-size: 3rem; 
            font-weight: 800; 
            color: var(--primary); 
            text-align: center;
            flex-grow: 1;
            display: flex;
            align-items: center;
            transition: all 0.3s ease;
        }

        .winner-pulse { animation: pulse 1.5s infinite; color: var(--gold) !important; }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.1); } 100% { transform: scale(1); } }

        .btn { padding: 18px 60px; border: none; border-radius: 12px; font-size: 1.4rem; font-weight: bold; cursor: pointer; transition: 0.3s; width: 100%; }
        .btn-draw { background: var(--primary); color: white; }
        .btn-draw:hover:not(:disabled) { background: #0d144d; transform: translateY(-3px); }
        .btn-draw:disabled { background: #bdc3c7; opacity: 0.7; }

        .btn-back { 
            background: var(--accent); 
            color: white; 
            display: none; 
            text-decoration: none; 
            text-align: center;
            font-size: 1.1rem;
            padding: 12px 30px;
            width: auto;
            margin-top: 20px;
        }

        .stats-info { margin-top: 15px; font-size: 1rem; color: #7f8c8d; font-weight: 600; }

        /* 注转 砖 */
        #error-msg { color: var(--error); font-size: 1.2rem; display: none; flex-direction: column; gap: 10px; }
        #countdown { font-size: 2rem; font-weight: 900; }
    </style>
</head>
<body>

    <h1 id="page-title" style="font-weight: 900; color: var(--primary); margin-bottom: 30px;">专转 砖转转驻</h1>

    <div class="raffle-container">
        <div class="raffle-box" id="mainBox">
            <div id="current-name">?</div>
            
            <div id="error-msg">
                <span> 爪 专住 专 专.</span>
                <span>专 祝 专砖 注:</span>
                <span id="countdown">5</span>
            </div>

            <button id="backBtn" class="btn btn-back" onclick="goToMain()"> 专 祝 专砖</button>
        </div>
        
        <button class="btn btn-draw" id="drawBtn" onclick="drawWinner()">专 专住!</button>
        
        <div class="stats-info" id="statsWrapper">
            专住 转: <strong id="count">0</strong>
        </div>
    </div>

    <audio id="winSound" src="crowd_cheer.ogg"></audio>

<script>
    let ticketsPool = [];
    let isDrawing = false;

    window.onload = () => {
        const hasTickets = loadPool();
        
        if (!hasTickets) {
            startRedirectSequence();
        }
    };

    function loadPool() {
        const stored = localStorage.getItem("participants");
        if (stored) {
            const data = JSON.parse(stored);
            ticketsPool = [];
            data.forEach(p => {
                for(let i=0; i<p.tickets; i++) {
                    ticketsPool.push(p.name);
                }
            });
            document.getElementById('count').textContent = ticketsPool.length;
            return ticketsPool.length > 0;
        }
        return false;
    }

    function startRedirectSequence() {
        // 住转专转  砖 专
        document.getElementById('current-name').style.display = 'none';
        document.getElementById('drawBtn').style.display = 'none';
        document.getElementById('statsWrapper').style.display = 'none';
        document.getElementById('page-title').textContent = '砖';
        
        // 爪转 注转 砖 住驻专 专
        const errorDiv = document.getElementById('error-msg');
        errorDiv.style.display = 'flex';
        
        let seconds = 5;
        const countdownEl = document.getElementById('countdown');
        
        const timer = setInterval(() => {
            seconds--;
            countdownEl.textContent = seconds;
            if (seconds <= 0) {
                clearInterval(timer);
                goToMain();
            }
        }, 1000);
    }

    function getSecureRandomIndex(max) {
        const array = new Uint32Array(1);
        window.crypto.getRandomValues(array);
        return array[0] % max;
    }

    function drawWinner() {
        if (isDrawing || ticketsPool.length === 0) return;
        
        isDrawing = true;
        document.getElementById('drawBtn').disabled = true;
        const display = document.getElementById('current-name');
        display.classList.remove('winner-pulse');
        
        const duration = 3000; 
        const shuffleInterval = setInterval(() => {
            display.textContent = ticketsPool[getSecureRandomIndex(ticketsPool.length)];
        }, 70);

        setTimeout(() => {
            clearInterval(shuffleInterval);
            const finalIndex = getSecureRandomIndex(ticketsPool.length);
            const winnerName = ticketsPool[finalIndex];
            
            display.textContent = winnerName;
            display.classList.add('winner-pulse');
            
            document.getElementById('winSound').play().catch(() => {});
            confetti({ particleCount: 150, spread: 70, origin: { y: 0.6 } });

            clearTicketsFromMemory();

            document.getElementById('drawBtn').style.display = 'none';
            document.getElementById('statsWrapper').style.visibility = 'hidden';
            document.getElementById('backBtn').style.display = 'block';
            
            isDrawing = false;
        }, duration);
    }

    function clearTicketsFromMemory() {
        const stored = localStorage.getItem("participants");
        if (stored) {
            const data = JSON.parse(stored);
            const resetData = data.map(p => ({
                name: p.name,
                tickets: 0,
                remainder: p.remainder
            }));
            localStorage.setItem("participants", JSON.stringify(resetData));
        }
    }

    function goToMain() {
        window.location.href = 'index.html';
    }
</script>
</body>
</html>
