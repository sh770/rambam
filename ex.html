<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
<meta charset="UTF-8">
<title>× ×™×ª×•×— ×¦×³××˜ ×•×•××˜×¡××¤</title>
<style>
  body { font-family: Arial, sans-serif; background:#f5f5f5; padding:20px; }
  textarea { width:100%; height:200px; margin-bottom:10px; }
  button { padding:10px 20px; border:none; background:#0078d7; color:white; border-radius:8px; cursor:pointer; margin-top:5px; }
  button:disabled { background:gray; }
  table { border-collapse: collapse; width:100%; margin-top:15px; background:white; }
  th, td { border:1px solid #ccc; padding:8px; text-align:center; }
  th { background:#e9e9e9; }
  h2 { margin-top:25px; }
  #error { color:red; font-weight:bold; }
  #summaryBox { background:white; padding:10px; border-radius:8px; margin-top:15px; }
  label { font-weight:bold; margin-top:10px; display:block; }
  .toggle-box { background:white; padding:10px; border-radius:8px; margin-top:15px; }
</style>
</head>
<body>

<h1>× ×™×ª×•×— × ×™×§×•×“ ×œ×¤×™ ×”×•×“×¢×•×ª ×•×•××˜×¡××¤</h1>

<label for="startOption">×¡× ×Ÿ ×”×•×“×¢×•×ª ×××–:</label>
<select id="startOption">
  <option value="">-- ××™×Ÿ ×¡×™× ×•×Ÿ --</option>
  <option value="date">×ª××¨×™×š</option>
  <option value="keyword">×”×•×“×¢×” ×”×ª×—×œ×ª×™×ª</option>
</select>

<input type="date" id="startDate" style="display:none;" />
<input type="text" id="startKeyword" placeholder="×œ×“×•×’××”: ×”×”×’×¨×œ×” ×”×‘××” ×ª×”×™×” ×‘×¡×•×£ ×¡×¤×¨" style="display:none; width:100%; padding:5px;" />

<label for="chatFile">××• ×”×¢×œ×” ×§×•×‘×¥ ×˜×§×¡×˜ ×©×œ ×”×¦×³××˜ (.txt):</label>
<input type="file" id="chatFile" accept=".txt" />

<label for="zipFile">××• ×”×¢×œ×” ×§×•×‘×¥ ZIP ×¢× TXT:</label>
<input type="file" id="zipFile" accept=".zip" />

<textarea id="textInput" placeholder="×”×“×‘×§ ×›××Ÿ ××ª ×ª×•×›×Ÿ ×”×¦×³××˜ ××•×•××˜×¡××¤..."></textarea>
<br>

<button id="analyzeBtn" onclick="analyzeText()">× ×ª×—</button>
<button onclick="resetScores()">××¤×¡ × ×™×§×•×“ ××¦×˜×‘×¨</button>

<div class="toggle-box">
  <label><input type="checkbox" id="currentOnly" /> ×”×¦×’ ×¨×§ ××©×ª××©×™× ××”× ×™×ª×•×— ×”× ×•×›×—×™</label>
</div>

<p id="error"></p>
<div id="summary"></div>
<div id="details"></div>
<div id="summaryBox"></div>

<!-- JSZip library -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>

<script>
// ğŸ”¹ Enhanced parse WhatsApp date
function parseWhatsAppDate(line) {
  line = line.replace(/[\u200E\u200F\u202A-\u202E]/g, '').trim();

  // ×¤×•×¨××˜ ×§×¦×¨ [d.m, hh:mm]
  let shortMatch = line.match(/\[(\d{1,2})\.(\d{1,2}),\s*(\d{1,2}):(\d{2})\]/);
  if (shortMatch) {
    const [ , day, month, hour, minute ] = shortMatch;
    const year = new Date().getFullYear();
    return new Date(`${year}-${month.padStart(2,'0')}-${day.padStart(2,'0')}T${hour.padStart(2,'0')}:${minute}:00`);
  }

  // ×¤×•×¨××˜ ××¨×•×š d.m.yyyy, hh:mm -
  let longMatch = line.match(/(\d{1,2})\.(\d{1,2})\.(\d{4}),\s*(\d{1,2}):(\d{2})/);
  if (longMatch) {
    const [ , day, month, year, hour, minute ] = longMatch;
    return new Date(`${year}-${month.padStart(2,'0')}-${day.padStart(2,'0')}T${hour.padStart(2,'0')}:${minute}:00`);
  }

  return null;
}

// ğŸ”¹ Process each message
function processMessage(users, name, content) {
  if (
    content.startsWith("<×”××“×™×” ×œ× × ×›×œ×œ×”>") ||
    content.includes("×”×¦×˜×¨×£") ||
    content.includes("×¢×–×‘") ||
    content.includes("×”×•×¡×¨") ||
    content.includes("×©×™× ×” ××ª ×©× ×”×§×‘×•×¦×”") ||
    content.includes("@â¨+972") ||
    content.includes("×”×•×“×¢×” ×–×• × ××—×§×”")
  ) return false;

  if (!users[name]) users[name] = { score:0, messages:0, checkCount:0, vCount:0 };

  const hasCheck = content.includes("âœ”ï¸");
  const hasV = content.includes("âœ…");
  let score = 1;
  if (hasV) score = 3;
  else if (hasCheck) score = 2;

  users[name].score += score;
  users[name].messages += 1;
  if (hasCheck) users[name].checkCount++;
  if (hasV) users[name].vCount++;

  return true;
}

// ğŸ”¹ File upload handling for TXT
document.getElementById("chatFile").addEventListener("change", function(event) {
  const file = event.target.files[0];
  if (!file) return;

  const reader = new FileReader();
  reader.onload = function(e) {
    document.getElementById("textInput").value = e.target.result;
    toggleAnalyzeButton();
  };
  reader.readAsText(file, "UTF-8");
});

// ğŸ”¹ File upload handling for ZIP
document.getElementById("zipFile").addEventListener("change", function(event) {
  const file = event.target.files[0];
  if (!file) return;

  const reader = new FileReader();
  reader.onload = function(e) {
    JSZip.loadAsync(e.target.result).then(function(zip) {
      const txtFile = Object.keys(zip.files).find(f => f.endsWith('.txt'));
      if (!txtFile) {
        alert("×œ× × ××¦× ×§×•×‘×¥ TXT ×‘×ª×•×š ×”-ZIP");
        return;
      }
      zip.file(txtFile).async("string").then(function(content) {
        document.getElementById("textInput").value = content;
        toggleAnalyzeButton();
      });
    });
  };
  reader.readAsArrayBuffer(file);
});

// ğŸ”¹ Show/hide input fields based on option
document.getElementById("startOption").addEventListener("change", function() {
  const option = this.value;
  document.getElementById("startDate").style.display = option === "date" ? "block" : "none";
  document.getElementById("startKeyword").style.display = option === "keyword" ? "block" : "none";
});

// ğŸ”¹ Toggle analyze button
function toggleAnalyzeButton() {
  const btn = document.getElementById("analyzeBtn");
  const text = document.getElementById("textInput").value.trim();
  btn.disabled = text.length === 0;
}

// ğŸ”¹ Main analyze function
function analyzeText() {
  const analyzeBtn = document.getElementById("analyzeBtn");
  const textInput = document.getElementById("textInput").value.trim();
  const startOption = document.getElementById("startOption").value;
  const startDateInput = document.getElementById("startDate").value;
  const startKeywordInput = document.getElementById("startKeyword").value.trim();
  const currentOnly = document.getElementById("currentOnly").checked;

  const errorEl = document.getElementById("error");
  const summaryEl = document.getElementById("summary");
  const detailsEl = document.getElementById("details");
  const summaryBox = document.getElementById("summaryBox");

  analyzeBtn.disabled = true;

  if (!textInput) {
    errorEl.innerText = "×× × ×”×“×‘×§ ××• ×”×¢×œ×” ×§×•×‘×¥ ×œ× ×™×ª×•×—";
    summaryEl.innerHTML = "";
    detailsEl.innerHTML = "";
    summaryBox.innerHTML = "";
    analyzeBtn.disabled = false;
    return;
  }

  errorEl.innerText = "";

  const lines = textInput.split('\n');
  const users = {};
  let pendingUser = null;
  let pendingContent = "";
  let totalMessages = 0, skippedMessages = 0, includedMessages = 0;
  let keywordReached = startOption === "keyword" ? false : true;
  let startDate = null;

  if (startOption === "date" && startDateInput) startDate = new Date(startDateInput);

  for (const line of lines) {
    // ğŸ”¹ ×¡×™× ×•×Ÿ ×œ×¤×™ ×ª××¨×™×š ××• ×”×•×“×¢×” ×”×ª×—×œ×ª×™×ª ×‘×ª×—×™×œ×ª ×”×œ×•×œ××”
    const msgDate = parseWhatsAppDate(line);
    if (startOption === "date" && startDate && msgDate && msgDate < startDate) continue;
    if (startOption === "keyword" && startKeywordInput && !keywordReached) {
      if (line.includes(startKeywordInput)) keywordReached = true;
      else continue;
    }

    const match = line.match(/^(?:\[\d{1,2}\.\d{1,2},\s*\d{1,2}:\d{2}\]|\d{1,2}\.\d{1,2}\.\d{4},\s*\d{1,2}:\d{2}\s*-\s*)([^:]+):\s*(.*)$/);
    if (match) {
      if (pendingUser && pendingContent) {
        const includeMessage = processMessage(users, pendingUser, pendingContent);
        if (includeMessage) includedMessages++; else skippedMessages++;
      }
      pendingUser = match[1].trim();
      pendingContent = match[2].trim();
      totalMessages++;
    } else if (pendingUser) {
      pendingContent += "\n" + line.trim();
    }
  }

  if (pendingUser && pendingContent) {
    const includeMessage = processMessage(users, pendingUser, pendingContent);
    if (includeMessage) includedMessages++; else skippedMessages++;
  }

  // ğŸ”¹ Update local storage for cumulative or current-only
  let storedData = JSON.parse(localStorage.getItem("userScores") || "{}");
  let resultData = {};

  if (currentOnly) resultData = users;
  else {
    for (const [name, data] of Object.entries(users)) {
      if (!storedData[name]) storedData[name] = { score:0, messages:0, checkCount:0, vCount:0 };
      storedData[name].score += data.score;
      storedData[name].messages += data.messages;
      storedData[name].checkCount += data.checkCount;
      storedData[name].vCount += data.vCount;
    }
    localStorage.setItem("userScores", JSON.stringify(storedData));
    resultData = storedData;
  }

  const summaryRows = Object.entries(resultData)
    .map(([name, data]) => `<tr><td>${name}</td><td>${data.score}</td><td>${data.messages}</td></tr>`).join("");
  summaryEl.innerHTML = `<h2>×˜×‘×œ×ª × ×™×§×•×“ ${currentOnly ? "××”× ×™×ª×•×— ×”× ×•×›×—×™ ×‘×œ×‘×“" : "××¦×˜×‘×¨×ª"}</h2>
    <table><thead><tr><th>×©×</th><th>× ×™×§×•×“</th><th>××¡×³ ×”×•×“×¢×•×ª</th></tr></thead><tbody>${summaryRows}</tbody></table>`;

  const detailsRows = Object.entries(resultData)
    .map(([name, data]) => `<tr><td>${name}</td><td>${data.checkCount}</td><td>${data.vCount}</td></tr>`).join("");
  detailsEl.innerHTML = `<h2>×¤×™×¨×•×˜ ×¡×™×× ×™×</h2>
    <table><thead><tr><th>×©×</th><th>âœ”ï¸</th><th>âœ…</th></tr></thead><tbody>${detailsRows}</tbody></table>`;

  summaryBox.innerHTML = `<h2>×¡×™×›×•× × ×™×ª×•×—</h2>
    <p>×¡×”×´×› ×”×•×“×¢×•×ª: <b>${totalMessages}</b></p>
    <p>× ×›×œ×œ×• ×‘× ×™×ª×•×—: <b>${includedMessages}</b></p>
    <p>×“×œ×’×• (××¢×¨×›×ª/××“×™×”): <b>${skippedMessages}</b></p>
  `;

  analyzeBtn.disabled = false;
}

// ğŸ”¹ Reset scores
function resetScores() {
  localStorage.removeItem("userScores");
  document.getElementById("summary").innerHTML = "";
  document.getElementById("details").innerHTML = "";
  document.getElementById("summaryBox").innerHTML = "";
  alert("×”× ×™×§×•×“ ×”××¦×˜×‘×¨ ××•×¤×¡ ×‘×”×¦×œ×—×”!");
}

// ğŸ”¹ Toggle analyze button on text change
document.getElementById("textInput").addEventListener("input", toggleAnalyzeButton);
window.addEventListener("DOMContentLoaded", toggleAnalyzeButton);
</script>

</body>
</html>