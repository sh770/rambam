<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
<meta charset="UTF-8">
<title>ניתוח ניקוד לפי הודעות וואטסאפ</title>
<style>
body {
  font-family: "Assistant", sans-serif;
  background: #fafafa;
  margin: 0;
  padding: 2rem;
  text-align: center;
}
textarea {
  width: 90%;
  height: 200px;
  direction: rtl;
}
button {
  margin: 0.5rem;
  padding: 0.5rem 1rem;
  font-size: 1rem;
  border-radius: 8px;
  border: none;
  cursor: pointer;
}
button:disabled {
  opacity: 0.5;
  cursor: not-allowed;
}
#results {
  margin-top: 2rem;
  background: white;
  border-radius: 12px;
  padding: 1rem;
  box-shadow: 0 0 5px rgba(0,0,0,0.1);
}
</style>
</head>
<body>

<h2>ניתוח ניקוד לפי הודעות וואטסאפ</h2>

<label>סנן הודעות מאז:</label><br>
<select id="startOption">
  <option value="none">הכל</option>
  <option value="date">תאריך</option>
  <option value="keyword">טקסט מסוים</option>
</select>

<div id="dateInputContainer" style="display:none;">
  <input type="date" id="startDate">
</div>

<div id="keywordInputContainer" style="display:none;">
  <input type="text" id="startKeywordInput" placeholder="הזן טקסט שממנו להתחיל ספירה">
</div>

<br><br>

<label>או העלה קובץ טקסט של הצ'אט (.txt):</label><br>
<input type="file" id="textFileInput" accept=".txt"><br><br>

<label>או העלה קובץ ZIP עם קובץ הצ'אט בפנים:</label><br>
<input type="file" id="zipFileInput" accept=".zip"><br><br>

<textarea id="chatInput" placeholder="הדבק כאן את תוכן הצ'אט..."></textarea><br>
<button id="clearTextButton">נקה תיבת טקסט</button>
<button id="analyzeButton" disabled>נתח</button>

<div id="results"></div>

<script>
// --- הצגת שדות לפי בחירה ---
document.getElementById("startOption").addEventListener("change", function() {
  document.getElementById("dateInputContainer").style.display =
    this.value === "date" ? "block" : "none";
  document.getElementById("keywordInputContainer").style.display =
    this.value === "keyword" ? "block" : "none";
});

// --- נקה טקסט ---
document.getElementById("clearTextButton").addEventListener("click", function() {
  document.getElementById("chatInput").value = "";
  document.getElementById("results").innerHTML = "";
  document.getElementById("analyzeButton").disabled = true;
});

// --- הפעלת כפתור ניתוח רק כשהוזן טקסט ---
document.getElementById("chatInput").addEventListener("input", function() {
  document.getElementById("analyzeButton").disabled = this.value.trim() === "";
});

// --- פונקציה לזיהוי תאריך ---
function parseWhatsAppDate(line) {
  try {
    line = line.replace(/\u202c|\u202a|\u200e/g, "").trim();
    const patterns = [
      /\[(\d{1,2})\.(\d{1,2}),\s*(\d{1,2}):(\d{2})\]/,
      /(\d{1,2})\.(\d{1,2})\.(\d{4}),\s*(\d{1,2}):(\d{2})/,
      /(\d{1,2})\.(\d{1,2})\.(\d{2}),\s*(\d{1,2}):(\d{2})/,
      /(\d{1,2})\.(\d{1,2}),\s*(\d{1,2}):(\d{2})/,
      /(\d{1,2}):(\d{2})\s*(\d{1,2})\.(\d{1,2})\.(\d{4})/,
      /(\d{1,2})\.(\d{1,2})\.(\d{4})\s*(\d{1,2}):(\d{2})/
    ];
    for (const p of patterns) {
      const m = line.match(p);
      if (m) {
        let day, month, year, hour, minute;
        if (p === patterns[4]) [, hour, minute, day, month, year] = m;
        else [, day, month, year, hour, minute] = m;
        year = year?.length === 2 ? "20" + year : year || new Date().getFullYear();
        return new Date(`${year}-${month}-${day}T${hour}:${minute}:00`);
      }
    }
  } catch { return null; }
  return null;
}

// --- קריאת קובץ TXT ---
document.getElementById("textFileInput").addEventListener("change", function(e) {
  const file = e.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = ev => {
    document.getElementById("chatInput").value = ev.target.result;
    document.getElementById("analyzeButton").disabled = false;
  };
  reader.readAsText(file);
});

// --- קריאת קובץ ZIP ---
document.getElementById("zipFileInput").addEventListener("change", async function(e) {
  const file = e.target.files[0];
  if (!file) return;
  const JSZip = await import("https://cdn.jsdelivr.net/npm/jszip@3.10.1/+esm");
  const zip = await JSZip.default.loadAsync(file);
  const txtFile = Object.keys(zip.files).find(name => name.endsWith(".txt"));
  if (!txtFile) return alert("לא נמצא קובץ טקסט בתוך ה־ZIP");
  const content = await zip.files[txtFile].async("string");
  document.getElementById("chatInput").value = content;
  document.getElementById("analyzeButton").disabled = false;
});

// --- ניתוח הודעות ---
document.getElementById("analyzeButton").addEventListener("click", function() {
  const button = this;
  button.disabled = true; // מניעת ספירה כפולה

  const text = document.getElementById("chatInput").value;
  const startOption = document.getElementById("startOption").value;
  const startDate = document.getElementById("startDate").value
    ? new Date(document.getElementById("startDate").value)
    : null;
  const startKeyword = document.getElementById("startKeywordInput").value?.trim() || "";
  const lines = text.split("\n");

  let results = [];
  let keywordReached = startOption !== "keyword";
  let currentUser = null;
  let currentContent = "";
  let includeCurrent = true;

  for (const line of lines) {
    const match = line.match(/^(?:\[?\d{1,2}\.\d{1,2}(?:\.\d{2,4})?,?\s*\d{1,2}:\d{2}.*?\]?\s*-?\s*)([^:]+):\s*(.*)$/);
    if (match) {
      const msgDate = parseWhatsAppDate(line);
      let include = true;
      if (startOption === "date" && startDate && msgDate && msgDate < startDate) include = false;
      if (startOption === "keyword" && !keywordReached) {
        if (line.includes(startKeyword)) { keywordReached = true; include = true; }
        else include = false;
      }

      if (currentUser && includeCurrent) results.push({ user: currentUser, text: currentContent });
      currentUser = match[1].trim();
      currentContent = match[2].trim();
      includeCurrent = include;
    } else if (currentUser) {
      currentContent += "\n" + line.trim();
    }
  }
  if (currentUser && includeCurrent) results.push({ user: currentUser, text: currentContent });

  document.getElementById("results").innerText =
    "נמצאו " + results.length + " הודעות לאחר הסינון.";
});
</script>
</body>
</html>